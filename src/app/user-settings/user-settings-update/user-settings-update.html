<mat-card class="account-card">
  <mat-card-content>
    <form [formGroup]="profileForm" (ngSubmit)="onSave()" class="account-form">

      <!-- Profile Header -->
      <section class="section profile-section">
        <h2 class="section-title">My Account</h2>
        <p class="section-subtitle">Manage your profile details and preferences.</p>

        <div class="profile-picture">
          <img *ngIf="avatarUrl; else defaultAvatar" [src]="avatarUrl" alt="User Picture" class="avatar-img">
          <ng-template #defaultAvatar>
            <div class="default-avatar">
              {{ (user.firstName.charAt(0) || '') + (user.lastName.charAt(0) || '') }}
            </div>
          </ng-template>
          <!-- <div class="edit-overlay">
            <mat-icon>edit</mat-icon>
          </div> -->
        </div>

        <div class="user-basic-info">
          <h3 class="user-name">{{ user.firstName }} {{ user.middleName || '' }} {{ user.lastName }}</h3>
          <p class="user-role">{{ user.role | titlecase }}</p>
        </div>
      </section>

      <mat-divider></mat-divider>

      <!-- Full Name -->
      <section class="section">
        <h2 class="section-title">Full Name</h2>
        <div class="form-grid">
          <mat-form-field appearance="outline" class="field">
            <mat-label>First Name</mat-label>
            <input matInput formControlName="firstName" />
            <mat-error>
              <app-form-control-errors [control]="profileForm.get('firstName')"></app-form-control-errors>
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Middle Name</mat-label>
            <input matInput formControlName="middleName" />
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Last Name</mat-label>
            <input matInput formControlName="lastName" />
            <mat-error>
              <app-form-control-errors [control]="profileForm.get('lastName')"></app-form-control-errors>
            </mat-error>
          </mat-form-field>
        </div>
      </section>

      <mat-divider></mat-divider>

      <!-- Account Info -->
      <section class="section">
        <h2 class="section-title">Account Information</h2>
        <div class="form-grid">
          <mat-form-field appearance="outline" class="field">
            <mat-label>Username</mat-label>
            <input matInput formControlName="username" />
            <mat-error>
              <app-form-control-errors [control]="profileForm.get('username')"></app-form-control-errors>
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Email Address</mat-label>
            <input matInput type="email" formControlName="emailAddress" />
            <mat-error>
              <app-form-control-errors [control]="profileForm.get('emailAddress')"></app-form-control-errors>
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Mobile Number</mat-label>
            <input matInput type="tel" formControlName="mobileNumber" />
            <mat-error>
              <app-form-control-errors [control]="profileForm.get('mobileNumber')"></app-form-control-errors>
            </mat-error>
          </mat-form-field>
        </div>
      </section>

      <mat-divider></mat-divider>

      <!-- Address Info -->
      <section class="section" formGroupName="address">
        <h2 class="section-title">Address</h2>
        <div class="form-grid">
          <mat-form-field appearance="outline" class="field">
            <mat-label>Province</mat-label>
            <input matInput formControlName="province" readonly />
            <mat-error>
              <app-form-control-errors [control]="profileForm.get('address.province')"></app-form-control-errors>
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Municipality</mat-label>
            <mat-select
              formControlName="municipality"
              (selectionChange)="onMunicipalitySelected($event.value)"
            >
              <mat-option value="">-- Select Municipality --</mat-option>
              @for (address of addresses; track address.name) {
                <mat-option [value]="address.name">{{ address.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field">
            <mat-label>Barangay</mat-label>
            <mat-select formControlName="barangay">
              <mat-option value="">-- Select Barangay --</mat-option>
              @for (barangay of barangays; track barangay.name) {
                <mat-option [value]="barangay.name">{{ barangay.name }}</mat-option>
              }
            </mat-select>
            <mat-error>
              <app-form-control-errors [control]="profileForm.get('address.barangay')"></app-form-control-errors>
            </mat-error>
          </mat-form-field>
        </div>
      </section>

      <mat-divider></mat-divider>

      <!-- Other Info -->
      <section class="section">
        <h2 class="section-title">Other Details</h2>
        <div class="form-grid">
          <mat-form-field appearance="outline" class="field">
            <mat-label>Gender</mat-label>
            <mat-select formControlName="gender">
              <mat-option value="male">Male</mat-option>
              <mat-option value="female">Female</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="field"  *ngIf="profileForm.get('rsbsaNumber')">
            <mat-label>RSBSA Number</mat-label>
            <input matInput formControlName="rsbsaNumber" />
            <mat-error>
              <app-form-control-errors [control]="profileForm.get('rsbsaNumber')"></app-form-control-errors>
            </mat-error>
          </mat-form-field>
        </div>
      </section>

      <mat-divider></mat-divider>

      <!-- Buttons -->
    <div class="button-group">
      <button 
        mat-raised-button 
        class="save-btn" 
        color="primary" 
        type="submit" 
        [disabled]="!profileForm.valid || isLoading">
        <mat-icon *ngIf="!isLoading">save</mat-icon>
        <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
        <span>{{ isLoading ? 'Saving...' : 'Save Changes' }}</span>
      </button>

      <button 
        mat-stroked-button 
        class="cancel-btn" 
        color="warn" 
        type="button" 
        (click)="cancelEdit()">
        <mat-icon>cancel</mat-icon>
        <span>Cancel</span>
      </button>
    </div>

    </form>
  </mat-card-content>
</mat-card>
